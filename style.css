let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
const taskInput = document.getElementById('taskInput');
const taskDate = document.getElementById('taskDate');
const addTaskBtn = document.getElementById('addTask');
const dailyTask = document.getElementById('dailyTask');
const taskList = document.getElementById('taskList');

// Fungsi simpan ke localStorage
function saveTasks() {
  localStorage.setItem('tasks', JSON.stringify(tasks));
}

// Fungsi tampilkan tugas
function displayTasks(filter = 'all') {
  taskList.innerHTML = '';

  let filtered = tasks.filter(task => {
    if (filter === 'active') return !task.done;
    if (filter === 'done') return task.done;
    return true;
  });

  filtered.forEach((task, index) => {
    const div = document.createElement('div');
    div.className = 'task-item' + (task.done ? ' done' : '');

    div.innerHTML = `
      <div class="info">
        <strong>${task.text}</strong>
        <span class="details">${task.date ? '📅 ' + task.date : ''}</span>
        ${task.isDaily ? '<span class="details">🔁 Tugas Harian</span>' : ''}
        <span class="streak">🔥 ${task.streak || 0} hari berturut-turut</span>
      </div>
      <div>
        <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleDone(${index})">
        <button class="delete-btn" onclick="deleteTask(${index})">🗑️</button>
      </div>
    `;

    taskList.appendChild(div);
  });
}

// Tambah tugas baru
addTaskBtn.addEventListener('click', () => {
  const text = taskInput.value.trim();
  const date = taskDate.value;
  if (!text) return;

  tasks.push({
    text,
    date,
    done: false,
    isDaily: dailyTask.checked,
    streak: 0,
    lastCompleted: null
  });

  taskInput.value = '';
  taskDate.value = '';
  dailyTask.checked = false;

  saveTasks();
  displayTasks();
});

// Toggle status selesai
function toggleDone(index) {
  const task = tasks[index];
  const today = new Date().toDateString();

  // Jika belum pernah selesai sebelumnya
  if (!task.lastCompleted) {
    task.streak = 1;
  } else {
    const lastDate = new Date(task.lastCompleted);
    const diff = (new Date(today) - lastDate) / (1000 * 60 * 60 * 24);

    if (diff === 1) {
      task.streak += 1;
    } else if (diff > 1) {
      task.streak = 1;
    }
  }

  task.done = !task.done;
  if (task.done) {
    task.lastCompleted = today;
  }

  saveTasks();
  displayTasks();
}

// Hapus tugas
function deleteTask(index) {
  tasks.splice(index, 1);
  saveTasks();
  displayTasks();
}

// Filter tombol
const filterButtons = document.querySelectorAll('.filter button');
filterButtons.forEach(button => {
  button.addEventListener('click', () => {
    filterButtons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');

    if (button.id === 'showAll') displayTasks('all');
    if (button.id === 'showActive') displayTasks('active');
    if (button.id === 'showDone') displayTasks('done');
  });
});

// Hapus semua tugas yang selesai
document.getElementById('clearDone').addEventListener('click', () => {
  tasks = tasks.filter(task => !task.done);
  saveTasks();
  displayTasks();
});

// Regenerasi tugas harian setiap hari
function resetDailyTasks() {
  const today = new Date().toDateString();

  tasks.forEach(task => {
    if (task.isDaily && task.lastCompleted !== today) {
      task.done = false;
    }
  });

  saveTasks();
}

// Jalankan ketika halaman dibuka
resetDailyTasks();
displayTasks();
